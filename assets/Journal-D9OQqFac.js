import{j as e}from"./vendor-charts-cvMpHz0W.js";import{r}from"./vendor-react-BdB5Pz3t.js";import{E as X,a as _,u as W,B as n,C as M,g as E}from"./index-IaNwoOYO.js";import{B as k}from"./Badge-CM23X0aP.js";import{I as m,S as p}from"./Input-BZ7duGHL.js";import{M as T}from"./Modal-J_gxoCCM.js";import{Y as h,B as Z,r as ee,aK as se,Q as w,H as ae,A as O,p as te,o as le,ax as P,ao as ie,ay as re,ab as ne,K as ce,m as oe,j as de}from"./vendor-icons-B6Rt7gcW.js";import"./vendor-export-C98UG4Mq.js";import"./vendor-utils-BBD155gO.js";const J={import:{icon:e.jsx(de,{className:"w-4 h-4"}),color:"text-info",bgColor:"bg-info/10",label:"Import"},modification:{icon:e.jsx(oe,{className:"w-4 h-4"}),color:"text-warning",bgColor:"bg-warning/10",label:"Modification"},suppression:{icon:e.jsx(ce,{className:"w-4 h-4"}),color:"text-danger",bgColor:"bg-danger/10",label:"Suppression"},creation:{icon:e.jsx(ne,{className:"w-4 h-4"}),color:"text-success",bgColor:"bg-success/10",label:"Création"},cloture:{icon:e.jsx(h,{className:"w-4 h-4"}),color:"text-primary-600",bgColor:"bg-primary-100",label:"Clôture"},validation:{icon:e.jsx(re,{className:"w-4 h-4"}),color:"text-success",bgColor:"bg-success/10",label:"Validation"},annulation:{icon:e.jsx(P,{className:"w-4 h-4"}),color:"text-danger",bgColor:"bg-danger/10",label:"Annulation"},restauration:{icon:e.jsx(w,{className:"w-4 h-4"}),color:"text-accent-500",bgColor:"bg-accent-100",label:"Restauration"}};function we(){var A,D,F;const{entries:j,periodesCloturees:me,isLoading:R,loadEntries:d,loadPeriodesCloturees:xe,getStats:B,cloturerPeriode:L,deverrouillerPeriode:ue}=X(),{centres:g}=_(),{addToast:y}=W(),[a,c]=r.useState({}),[v,N]=r.useState(!1),[Q,S]=r.useState(!1),[q,x]=r.useState(!1),[o,V]=r.useState(null),[$,H]=r.useState(null),[t,u]=r.useState({centreId:"",annee:new Date().getFullYear(),mois:new Date().getMonth()+1,justification:""});r.useEffect(()=>{d(a)},[]);const I=()=>{d(a),N(!1)},K=()=>{c({}),d({}),N(!1)},z=async()=>{const s=await B(a);V(s),S(!0)},G=async()=>{await L(t.centreId,t.annee,t.mois,t.justification)?(y({type:"success",title:"Période clôturée",message:`La période ${t.mois}/${t.annee} a été clôturée`}),x(!1),d(a)):y({type:"error",title:"Erreur",message:"Impossible de clôturer cette période"})},b=s=>new Date(s).toLocaleString("fr-FR",{day:"2-digit",month:"2-digit",year:"numeric",hour:"2-digit",minute:"2-digit"}),Y=s=>{var l;return s?((l=g.find(i=>i.id===s))==null?void 0:l.nom)||s:"Global"},U=[{value:"1",label:"Janvier"},{value:"2",label:"Février"},{value:"3",label:"Mars"},{value:"4",label:"Avril"},{value:"5",label:"Mai"},{value:"6",label:"Juin"},{value:"7",label:"Juillet"},{value:"8",label:"Août"},{value:"9",label:"Septembre"},{value:"10",label:"Octobre"},{value:"11",label:"Novembre"},{value:"12",label:"Décembre"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-primary-900",children:"Journal des Modifications"}),e.jsx("p",{className:"text-primary-500 mt-1",children:"Historique et traçabilité de toutes les opérations sur les données"})]}),e.jsxs("div",{className:"flex gap-2",children:[e.jsx(n,{variant:"secondary",onClick:()=>x(!0),leftIcon:e.jsx(h,{className:"w-4 h-4"}),children:"Clôturer période"}),e.jsx(n,{variant:"secondary",onClick:z,leftIcon:e.jsx(Z,{className:"w-4 h-4"}),children:"Statistiques"})]})]}),e.jsx(M,{children:e.jsxs(E,{className:"pt-4",children:[e.jsxs("div",{className:"flex gap-4",children:[e.jsx("div",{className:"flex-1",children:e.jsx(m,{placeholder:"Rechercher dans le journal...",value:a.recherche||"",onChange:s=>c({...a,recherche:s.target.value}),leftIcon:e.jsx(ee,{className:"w-4 h-4"}),onKeyDown:s=>s.key==="Enter"&&I()})}),e.jsx(n,{variant:v?"primary":"secondary",onClick:()=>N(!v),leftIcon:e.jsx(se,{className:"w-4 h-4"}),children:"Filtres"}),e.jsx(n,{variant:"secondary",onClick:()=>d(a),leftIcon:e.jsx(w,{className:"w-4 h-4"}),children:"Actualiser"})]}),v&&e.jsxs("div",{className:"mt-4 pt-4 border-t border-primary-100 grid grid-cols-4 gap-4",children:[e.jsx(p,{label:"Centre",value:a.centreId||"",onChange:s=>c({...a,centreId:s.target.value||void 0}),options:[{value:"",label:"Tous les centres"},...g.map(s=>({value:s.id,label:s.nom}))]}),e.jsx(p,{label:"Type d'action",value:((A=a.actions)==null?void 0:A[0])||"",onChange:s=>c({...a,actions:s.target.value?[s.target.value]:void 0}),options:[{value:"",label:"Toutes les actions"},{value:"import",label:"Import"},{value:"modification",label:"Modification"},{value:"suppression",label:"Suppression"},{value:"creation",label:"Création"},{value:"cloture",label:"Clôture"}]}),e.jsx(m,{type:"date",label:"Date début",value:((D=a.dateDebut)==null?void 0:D.split("T")[0])||"",onChange:s=>c({...a,dateDebut:s.target.value?new Date(s.target.value).toISOString():void 0})}),e.jsx(m,{type:"date",label:"Date fin",value:((F=a.dateFin)==null?void 0:F.split("T")[0])||"",onChange:s=>c({...a,dateFin:s.target.value?new Date(s.target.value).toISOString():void 0})}),e.jsxs("div",{className:"col-span-4 flex justify-end gap-2",children:[e.jsx(n,{variant:"ghost",onClick:K,children:"Réinitialiser"}),e.jsx(n,{variant:"primary",onClick:I,children:"Appliquer les filtres"})]})]})]})}),e.jsxs("div",{className:"flex items-center justify-between text-sm text-primary-500",children:[e.jsxs("span",{children:[j.length," entrées trouvées"]}),a.dateDebut&&e.jsxs("span",{children:["Période: ",b(a.dateDebut)," - ",a.dateFin?b(a.dateFin):"Maintenant"]})]}),e.jsx(M,{children:e.jsx(E,{className:"p-0",children:R?e.jsx("div",{className:"flex items-center justify-center py-12",children:e.jsx(w,{className:"w-6 h-6 text-primary-400 animate-spin"})}):j.length===0?e.jsxs("div",{className:"text-center py-12",children:[e.jsx(ae,{className:"w-12 h-12 mx-auto mb-3 text-primary-300"}),e.jsx("p",{className:"text-primary-500",children:"Aucune entrée dans le journal"}),e.jsx("p",{className:"text-sm text-primary-400 mt-1",children:"Les opérations sur les données apparaîtront ici"})]}):e.jsx("div",{className:"divide-y divide-primary-100",children:j.map(s=>{const l=J[s.action],i=$===s.id;return e.jsxs("div",{className:"hover:bg-primary-50 transition-colors",children:[e.jsxs("div",{className:"flex items-center gap-4 p-4 cursor-pointer",onClick:()=>H(i?null:s.id),children:[e.jsx("div",{className:`p-2 rounded-lg ${l.bgColor}`,children:e.jsx("span",{className:l.color,children:l.icon})}),e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(k,{variant:s.action==="import"?"info":s.action==="modification"?"warning":s.action==="suppression"?"danger":s.action==="creation"?"success":"secondary",children:l.label}),e.jsx("span",{className:"text-sm font-medium text-primary-900",children:s.table}),s.erreurs&&s.erreurs.length>0&&e.jsxs(k,{variant:"danger",icon:e.jsx(O,{className:"w-3 h-3"}),children:[s.erreurs.length," erreurs"]})]}),e.jsxs("p",{className:"text-sm text-primary-500 mt-1",children:[s.enregistrementsAffectes," enregistrement",s.enregistrementsAffectes>1?"s":""," affecté",s.enregistrementsAffectes>1?"s":"",s.details.fichierSource&&e.jsxs("span",{className:"ml-2",children:["- ",s.details.fichierSource]})]})]}),e.jsxs("div",{className:"text-right",children:[e.jsx("p",{className:"text-sm text-primary-900",children:b(s.date)}),e.jsx("p",{className:"text-xs text-primary-500",children:Y(s.details.centreId)})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[s.scoreQualite!==void 0&&e.jsxs("div",{className:`px-2 py-1 rounded text-sm font-medium ${s.scoreQualite>=90?"bg-success/10 text-success":s.scoreQualite>=70?"bg-warning/10 text-warning":"bg-danger/10 text-danger"}`,children:[s.scoreQualite,"%"]}),i?e.jsx(te,{className:"w-5 h-5 text-primary-400"}):e.jsx(le,{className:"w-5 h-5 text-primary-400"})]})]}),i&&e.jsxs("div",{className:"px-4 pb-4 ml-14 space-y-3",children:[e.jsxs("div",{className:"p-3 bg-primary-50 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-primary-700 mb-2",children:"Détails"}),e.jsxs("div",{className:"grid grid-cols-2 gap-2 text-sm",children:[s.details.entiteId&&e.jsxs("div",{children:[e.jsx("span",{className:"text-primary-500",children:"ID Entité:"}),e.jsx("span",{className:"ml-2 font-mono text-primary-900",children:s.details.entiteId})]}),s.details.champModifie&&e.jsxs("div",{children:[e.jsx("span",{className:"text-primary-500",children:"Champ:"}),e.jsx("span",{className:"ml-2 text-primary-900",children:s.details.champModifie})]}),s.details.ancienneValeur!==void 0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-primary-500",children:"Ancienne valeur:"}),e.jsx("span",{className:"ml-2 text-danger",children:String(s.details.ancienneValeur)})]}),s.details.nouvelleValeur!==void 0&&e.jsxs("div",{children:[e.jsx("span",{className:"text-primary-500",children:"Nouvelle valeur:"}),e.jsx("span",{className:"ml-2 text-success",children:String(s.details.nouvelleValeur)})]}),s.details.justification&&e.jsxs("div",{className:"col-span-2",children:[e.jsx("span",{className:"text-primary-500",children:"Justification:"}),e.jsx("span",{className:"ml-2 text-primary-900",children:s.details.justification})]})]})]}),s.erreurs&&s.erreurs.length>0&&e.jsxs("div",{className:"p-3 bg-danger/10 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-danger mb-2",children:"Erreurs"}),e.jsx("ul",{className:"text-sm text-primary-700 space-y-1",children:s.erreurs.map((f,C)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(P,{className:"w-4 h-4 text-danger mt-0.5 flex-shrink-0"}),f]},C))})]}),s.avertissements&&s.avertissements.length>0&&e.jsxs("div",{className:"p-3 bg-warning/10 rounded-lg",children:[e.jsx("h4",{className:"text-sm font-medium text-warning mb-2",children:"Avertissements"}),e.jsx("ul",{className:"text-sm text-primary-700 space-y-1",children:s.avertissements.map((f,C)=>e.jsxs("li",{className:"flex items-start gap-2",children:[e.jsx(O,{className:"w-4 h-4 text-warning mt-0.5 flex-shrink-0"}),f]},C))})]})]})]},s.id)})})})}),e.jsx(T,{isOpen:Q,onClose:()=>S(!1),title:"Statistiques du Journal",size:"lg",children:o&&e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsxs("div",{className:"p-4 bg-primary-50 rounded-lg text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-primary-900",children:o.totalEntrees}),e.jsx("p",{className:"text-sm text-primary-500",children:"Entrées totales"})]}),e.jsxs("div",{className:"p-4 bg-danger/10 rounded-lg text-center",children:[e.jsx("p",{className:"text-3xl font-bold text-danger",children:o.erreursTotales}),e.jsx("p",{className:"text-sm text-primary-500",children:"Erreurs"})]}),e.jsxs("div",{className:"p-4 bg-success/10 rounded-lg text-center",children:[e.jsxs("p",{className:"text-3xl font-bold text-success",children:[o.scoreQualiteMoyen.toFixed(0),"%"]}),e.jsx("p",{className:"text-sm text-primary-500",children:"Score qualité moyen"})]})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-primary-900 mb-3",children:"Par type d'action"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(o.parAction).map(([s,l])=>{const i=J[s];return e.jsxs("div",{className:"flex items-center justify-between p-2 bg-primary-50 rounded",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:i.color,children:i.icon}),e.jsx("span",{className:"text-sm text-primary-700",children:i.label})]}),e.jsx("span",{className:"font-medium text-primary-900",children:l})]},s)})})]}),e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-primary-900 mb-3",children:"Par table"}),e.jsx("div",{className:"grid grid-cols-2 gap-2",children:Object.entries(o.parTable).map(([s,l])=>e.jsxs("div",{className:"flex items-center justify-between p-2 bg-primary-50 rounded",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(ie,{className:"w-4 h-4 text-primary-400"}),e.jsx("span",{className:"text-sm text-primary-700",children:s})]}),e.jsx("span",{className:"font-medium text-primary-900",children:l})]},s))})]})]})}),e.jsx(T,{isOpen:q,onClose:()=>x(!1),title:"Clôturer une période",size:"md",children:e.jsxs("div",{className:"space-y-4",children:[e.jsx("div",{className:"p-4 bg-warning/10 border border-warning/30 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(h,{className:"w-5 h-5 text-warning mt-0.5"}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-warning",children:"Attention"}),e.jsx("p",{className:"text-sm text-primary-700 mt-1",children:"La clôture d'une période empêche toute modification des données de cette période. Cette action peut être déverrouillée temporairement si nécessaire."})]})]})}),e.jsx(p,{label:"Centre",value:t.centreId,onChange:s=>u({...t,centreId:s.target.value}),options:[{value:"",label:"Sélectionner un centre"},...g.map(s=>({value:s.id,label:s.nom}))]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(p,{label:"Mois",value:String(t.mois),onChange:s=>u({...t,mois:parseInt(s.target.value)}),options:U}),e.jsx(m,{type:"number",label:"Année",value:t.annee,onChange:s=>u({...t,annee:parseInt(s.target.value)}),min:2020,max:2030})]}),e.jsx(m,{label:"Justification (optionnelle)",value:t.justification,onChange:s=>u({...t,justification:s.target.value}),placeholder:"Raison de la clôture..."}),e.jsxs("div",{className:"flex justify-end gap-3 pt-4",children:[e.jsx(n,{variant:"secondary",onClick:()=>x(!1),children:"Annuler"}),e.jsx(n,{variant:"primary",onClick:G,disabled:!t.centreId,leftIcon:e.jsx(h,{className:"w-4 h-4"}),children:"Clôturer la période"})]})]})})]})}export{we as Journal};
