import{j as e}from"./vendor-charts-cvMpHz0W.js";import{e as se,r as c}from"./vendor-react-BdB5Pz3t.js";import{a as te,u as re,b as ae,c as le,C as I,B as u,g as ie}from"./index-IaNwoOYO.js";import{a as ne}from"./Badge-CM23X0aP.js";import{I as o,T as E,S as ce}from"./Input-BZ7duGHL.js";import{M as q,C as oe}from"./Modal-J_gxoCCM.js";import{p as ue,o as de,ab as me,P as pe,af as xe,K as he,T as ge}from"./vendor-icons-B6Rt7gcW.js";import{f as je}from"./vendor-utils-BBD155gO.js";import"./vendor-export-C98UG4Mq.js";function ke(){const{centreId:n}=se(),v=te(s=>s.getCentre(n||"")),{addToast:d}=re(),{axes:fe,objectifs:ve,loadAxes:D,loadObjectifs:F,getAxesByCentre:V,getObjectifsByAxe:S,addObjectif:T,updateObjectif:z,deleteObjectif:B}=ae(),{mesures:K,loadMesures:$,getLastMesure:M,addMesure:L,calculerStatut:X}=le(),[w,G]=c.useState(new Set),[H,g]=c.useState(!1),[J,j]=c.useState(!1),[Q,b]=c.useState(!1),[A,k]=c.useState(null),[a,m]=c.useState(null),[r,i]=c.useState({code:"",intitule:"",description:"",kpiNom:"",cible:"",poids:10,frequenceMesure:"mensuel",seuilVert:100,seuilOrange:80,seuilRouge:60}),[p,N]=c.useState({valeurReelle:0,commentaire:""});c.useEffect(()=>{n&&(D(n),F(n),$(n))},[n]);const R=V(n||""),U=s=>{const t=new Set(w);t.has(s)?t.delete(s):t.add(s),G(t)},y=()=>{i({code:"",intitule:"",description:"",kpiNom:"",cible:"",poids:10,frequenceMesure:"mensuel",seuilVert:100,seuilOrange:80,seuilRouge:60}),m(null),k(null)},P=(s,t)=>{if(k(s),t)m(t),i({code:t.code,intitule:t.intitule,description:t.description,kpiNom:t.kpiNom,cible:String(t.cible),poids:t.poids,frequenceMesure:t.frequenceMesure,seuilVert:t.seuilVert,seuilOrange:t.seuilOrange,seuilRouge:t.seuilRouge});else{y();const h=S(s.id).length+1;i(O=>({...O,code:`${s.code.replace("AXE","")}.${h}`}))}g(!0)},Y=async()=>{if(!(!A||!n))try{const s={...r,axeId:A.id,centreId:n};a?(await z(a.id,s),d({type:"success",title:"Objectif modifié"})):(await T(s),d({type:"success",title:"Objectif créé"})),g(!1),y()}catch(s){d({type:"error",title:"Erreur",message:String(s)})}},W=async()=>{if(a)try{await B(a.id),d({type:"success",title:"Objectif supprimé"}),b(!1),m(null)}catch(s){d({type:"error",title:"Erreur",message:String(s)})}},Z=s=>{m(s);const t=M(s.id);N({valeurReelle:(t==null?void 0:t.valeurReelle)||0,commentaire:""}),j(!0)},_=async()=>{if(!(!a||!n))try{const s=new Date,t=X(p.valeurReelle,a.seuilVert,a.seuilOrange,a.seuilRouge);await L({objectifId:a.id,centreId:n,periode:{annee:s.getFullYear(),mois:s.getMonth()+1},valeurReelle:p.valeurReelle,valeurCible:Number(a.cible),ecart:0,ecartPourcentage:0,statut:t,commentaire:p.commentaire,piecesJointes:[],dateSaisie:s.toISOString(),saisiePar:"DGA"}),d({type:"success",title:"Mesure enregistrée"}),j(!1),m(null)}catch(s){d({type:"error",title:"Erreur",message:String(s)})}},ee=[{value:"quotidien",label:"Quotidien"},{value:"hebdomadaire",label:"Hebdomadaire"},{value:"mensuel",label:"Mensuel"},{value:"bimestriel",label:"Bimestriel"},{value:"trimestriel",label:"Trimestriel"},{value:"semestriel",label:"Semestriel"},{value:"annuel",label:"Annuel"}];return e.jsxs("div",{className:"space-y-6",children:[e.jsx("div",{className:"flex items-center justify-between",children:e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-primary-900",children:"Pilotage stratégique"}),e.jsxs("p",{className:"text-primary-500 mt-1",children:[v==null?void 0:v.nom," — Objectifs et indicateurs de performance"]})]})}),e.jsxs("div",{className:"space-y-4",children:[R.map(s=>{const t=S(s.id),C=w.has(s.id),h=K.filter(l=>t.some(x=>x.id===l.objectifId)),O=h.filter(l=>l.statut==="vert").length,f=h.length>0?Math.round(O/h.length*100):0;return e.jsxs(I,{className:"overflow-hidden",children:[e.jsxs("div",{className:"flex items-center justify-between p-4 cursor-pointer hover:bg-primary-50 transition-colors",onClick:()=>U(s.id),children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"w-12 h-12 rounded-lg flex items-center justify-center text-white font-bold",style:{backgroundColor:s.couleur},children:s.code.replace("AXE","")}),e.jsxs("div",{children:[e.jsx("h3",{className:"font-semibold text-primary-900",children:s.nom}),e.jsxs("p",{className:"text-sm text-primary-500",children:[t.length," objectif(s) — Poids: ",s.poids,"%"]})]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("div",{className:"w-24 h-2 bg-primary-200 rounded-full overflow-hidden",children:e.jsx("div",{className:"h-full rounded-full",style:{width:`${f}%`,backgroundColor:f>=80?"#22c55e":f>=60?"#f59e0b":"#ef4444"}})}),e.jsxs("span",{className:"text-sm font-medium text-primary-600 w-10",children:[f,"%"]})]}),C?e.jsx(ue,{className:"w-5 h-5 text-primary-400"}):e.jsx(de,{className:"w-5 h-5 text-primary-400"})]})]}),C&&e.jsxs("div",{className:"border-t border-primary-200 p-4",children:[e.jsx("div",{className:"flex justify-end mb-4",children:e.jsx(u,{variant:"secondary",size:"sm",leftIcon:e.jsx(me,{className:"w-4 h-4"}),onClick:l=>{l.stopPropagation(),P(s)},children:"Ajouter un objectif"})}),t.length>0?e.jsx("div",{className:"space-y-3",children:t.map(l=>{const x=M(l.id);return e.jsxs("div",{className:"flex items-center justify-between p-4 bg-primary-50 rounded-lg",children:[e.jsxs("div",{className:"flex-1",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"text-sm font-mono text-primary-500",children:l.code}),e.jsx("h4",{className:"font-medium text-primary-900",children:l.intitule})]}),e.jsxs("p",{className:"text-sm text-primary-500 mt-1",children:["KPI: ",l.kpiNom," — Cible: ",l.cible]})]}),e.jsxs("div",{className:"flex items-center gap-4",children:[x?e.jsxs("div",{className:"text-right",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:"font-semibold text-primary-900",children:x.valeurReelle}),e.jsx(ne,{statut:x.statut})]}),e.jsx("p",{className:"text-xs text-primary-500",children:je(new Date(x.dateSaisie),"dd/MM/yyyy")})]}):e.jsx("span",{className:"text-sm text-primary-400",children:"Non mesuré"}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>Z(l),children:e.jsx(pe,{className:"w-4 h-4"})}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>P(s,l),children:e.jsx(xe,{className:"w-4 h-4"})}),e.jsx(u,{variant:"ghost",size:"sm",onClick:()=>{m(l),b(!0)},children:e.jsx(he,{className:"w-4 h-4 text-error"})})]})]})]},l.id)})}):e.jsxs("div",{className:"text-center py-8 text-primary-500",children:[e.jsx(ge,{className:"w-8 h-8 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Aucun objectif défini pour cet axe"})]})]})]},s.id)}),R.length===0&&e.jsx(I,{children:e.jsx(ie,{className:"text-center py-12",children:e.jsx("p",{className:"text-primary-500",children:"Aucun axe stratégique configuré pour ce centre"})})})]}),e.jsx(q,{isOpen:H,onClose:()=>{g(!1),y()},title:a?"Modifier l'objectif":"Nouvel objectif",size:"lg",footer:e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"ghost",onClick:()=>g(!1),children:"Annuler"}),e.jsx(u,{onClick:Y,children:a?"Enregistrer":"Créer"})]}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(o,{label:"Code",value:r.code,onChange:s=>i({...r,code:s.target.value})}),e.jsx(o,{label:"Poids (%)",type:"number",min:1,max:100,value:r.poids,onChange:s=>i({...r,poids:Number(s.target.value)})})]}),e.jsx(o,{label:"Intitulé",value:r.intitule,onChange:s=>i({...r,intitule:s.target.value})}),e.jsx(E,{label:"Description",rows:2,value:r.description,onChange:s=>i({...r,description:s.target.value})}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(o,{label:"Nom du KPI",value:r.kpiNom,onChange:s=>i({...r,kpiNom:s.target.value})}),e.jsx(o,{label:"Cible",value:r.cible,onChange:s=>i({...r,cible:s.target.value})})]}),e.jsx(ce,{label:"Fréquence de mesure",options:ee,value:r.frequenceMesure,onChange:s=>i({...r,frequenceMesure:s.target.value})}),e.jsxs("div",{className:"grid grid-cols-3 gap-4",children:[e.jsx(o,{label:"Seuil vert (≥)",type:"number",value:r.seuilVert,onChange:s=>i({...r,seuilVert:Number(s.target.value)})}),e.jsx(o,{label:"Seuil orange (≥)",type:"number",value:r.seuilOrange,onChange:s=>i({...r,seuilOrange:Number(s.target.value)})}),e.jsx(o,{label:"Seuil rouge (<)",type:"number",value:r.seuilRouge,onChange:s=>i({...r,seuilRouge:Number(s.target.value)})})]})]})}),e.jsx(q,{isOpen:J,onClose:()=>{j(!1),m(null)},title:"Saisir une mesure",size:"md",footer:e.jsxs(e.Fragment,{children:[e.jsx(u,{variant:"ghost",onClick:()=>j(!1),children:"Annuler"}),e.jsx(u,{onClick:_,children:"Enregistrer"})]}),children:a&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-primary-50 rounded-lg",children:[e.jsx("p",{className:"font-medium text-primary-900",children:a.intitule}),e.jsxs("p",{className:"text-sm text-primary-500 mt-1",children:["KPI: ",a.kpiNom," — Cible: ",a.cible]})]}),e.jsx(o,{label:"Valeur réalisée",type:"number",value:p.valeurReelle,onChange:s=>N({...p,valeurReelle:Number(s.target.value)})}),e.jsx(E,{label:"Commentaire (optionnel)",rows:3,value:p.commentaire,onChange:s=>N({...p,commentaire:s.target.value})})]})}),e.jsx(oe,{isOpen:Q,onClose:()=>b(!1),onConfirm:W,title:"Supprimer l'objectif",message:`Êtes-vous sûr de vouloir supprimer "${a==null?void 0:a.intitule}" ? Cette action supprimera également toutes les mesures associées.`,confirmLabel:"Supprimer",variant:"danger"})]})}export{ke as Pilotage};
