import{j as e}from"./vendor-charts-cvMpHz0W.js";import{e as Ae,r as c}from"./vendor-react-BdB5Pz3t.js";import{a as Me,u as De,b as Ie,k as Oe,B as i,C as j,g as v,h as U,i as Q}from"./index-IaNwoOYO.js";import{B as C}from"./Badge-CM23X0aP.js";import{S as f,I as w,T as Y}from"./Input-BZ7duGHL.js";import{M as V,C as Le}from"./Modal-J_gxoCCM.js";import{ab as T,g as $,y as _,A as G,N as K,p as ke,o as Ee,H as Fe,af as Ve,K as Te,a7 as $e,ah as He,f as Be}from"./vendor-icons-B6Rt7gcW.js";import{f as W}from"./vendor-utils-BBD155gO.js";import{f as ze}from"./fr-C0qvdQu_.js";import"./vendor-export-C98UG4Mq.js";const Re={quotidien:"Quotidien",hebdomadaire:"Hebdomadaire",mensuel:"Mensuel",bimestriel:"Bimestriel",trimestriel:"Trimestriel",semestriel:"Semestriel",annuel:"Annuel"},X={brouillon:"Brouillon",valide:"Validé",envoye:"Envoyé"},Z={brouillon:"bg-primary-100 text-primary-700 border-primary-200",valide:"bg-warning/10 text-warning border-warning/20",envoye:"bg-success/10 text-success border-success/20"};function as(){const{centreId:n}=Ae(),S=Me(s=>s.getCentre(n||"")),{addToast:d}=De(),{axes:Pe,loadAxes:ee,getAxesByCentre:se}=Ie(),{livrables:Je,loadLivrables:q,getLivrablesByCentre:ae,addLivrable:re,updateLivrable:te,deleteLivrable:ie,addVersion:le,changerStatutVersion:ne,getDerniereVersion:oe,getProchaineLivraison:ce,isLivrableEnRetard:A}=Oe(),[de,N]=c.useState(!1),[me,b]=c.useState(!1),[xe,M]=c.useState(!1),[ue,D]=c.useState(!1),[r,u]=c.useState(null),[H,pe]=c.useState(new Set),[p,he]=c.useState("all"),[I,je]=c.useState("all"),[t,m]=c.useState({titre:"",description:"",axeId:"",frequence:"mensuel",destinataire:"",modele:""}),[l,y]=c.useState({periode:{annee:new Date().getFullYear(),mois:new Date().getMonth()+1},commentaires:""});c.useEffect(()=>{n&&(ee(n),q(n))},[n]);const g=se(n||""),h=ae(n||"").filter(s=>!(p!=="all"&&s.axeId!==p||I!=="all"&&s.frequence!==I)),ve=g.reduce((s,a)=>(s[a.id]=h.filter(o=>o.axeId===a.id),s),{}),O=h.filter(s=>!s.axeId),ge=h.filter(s=>A(s)),fe=h.filter(s=>!A(s)),Ne=s=>{const a=new Set(H);a.has(s)?a.delete(s):a.add(s),pe(a)},L=()=>{var s;m({titre:"",description:"",axeId:((s=g[0])==null?void 0:s.id)||"",frequence:"mensuel",destinataire:"",modele:""}),u(null)},k=()=>{y({periode:{annee:new Date().getFullYear(),mois:new Date().getMonth()+1},commentaires:""})},E=s=>{s?(u(s),m({titre:s.titre,description:s.description,axeId:s.axeId,frequence:s.frequence,destinataire:s.destinataire,modele:s.modele||""})):L(),N(!0)},be=s=>{u(s),k(),b(!0)},ye=s=>{u(s),D(!0)},Ce=async()=>{if(!(!n||!t.titre||!t.axeId))try{r?(await te(r.id,t),d({type:"success",title:"Livrable modifié"})):(await re({...t,centreId:n,historique:[]}),d({type:"success",title:"Livrable créé"})),N(!1),L()}catch(s){d({type:"error",title:"Erreur",message:String(s)})}},we=async()=>{if(r)try{await le(r.id,{dateCreation:new Date().toISOString(),periode:l.periode,fichier:{id:crypto.randomUUID(),nom:`${r.titre}_${l.periode.annee}_${l.periode.mois}.pdf`,type:"application/pdf",taille:0,contenu:"",dateAjout:new Date().toISOString()},statut:"brouillon",commentaires:l.commentaires}),d({type:"success",title:"Version ajoutée"}),b(!1),k(),q(n)}catch(s){d({type:"error",title:"Erreur",message:String(s)})}},Se=async()=>{if(r)try{await ie(r.id),d({type:"success",title:"Livrable supprimé"}),M(!1),u(null)}catch(s){d({type:"error",title:"Erreur",message:String(s)})}},B=async(s,a,o)=>{try{await ne(s.id,a,o),d({type:"success",title:"Statut mis à jour"}),q(n)}catch(x){d({type:"error",title:"Erreur",message:String(x)})}},z=[{value:"quotidien",label:"Quotidien"},{value:"hebdomadaire",label:"Hebdomadaire"},{value:"mensuel",label:"Mensuel"},{value:"bimestriel",label:"Bimestriel"},{value:"trimestriel",label:"Trimestriel"},{value:"semestriel",label:"Semestriel"},{value:"annuel",label:"Annuel"}],R=g.map(s=>({value:s.id,label:s.nom})),F=[{value:"1",label:"Janvier"},{value:"2",label:"Février"},{value:"3",label:"Mars"},{value:"4",label:"Avril"},{value:"5",label:"Mai"},{value:"6",label:"Juin"},{value:"7",label:"Juillet"},{value:"8",label:"Août"},{value:"9",label:"Septembre"},{value:"10",label:"Octobre"},{value:"11",label:"Novembre"},{value:"12",label:"Décembre"}],P=({livrable:s})=>{var J;const a=oe(s),o=ce(s),x=A(s);return g.find(qe=>qe.id===s.axeId),e.jsxs("div",{className:`bg-white p-4 rounded-lg border shadow-sm hover:shadow-md transition-shadow ${x?"border-error/30 bg-error/5":"border-primary-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between gap-2 mb-3",children:[e.jsxs("div",{children:[e.jsx("h4",{className:"font-medium text-primary-900",children:s.titre}),s.description&&e.jsx("p",{className:"text-xs text-primary-500 mt-1 line-clamp-2",children:s.description})]}),e.jsxs("div",{className:"flex items-center gap-1",children:[e.jsx(i,{variant:"ghost",size:"sm",onClick:()=>ye(s),children:e.jsx(Fe,{className:"w-4 h-4"})}),e.jsx(i,{variant:"ghost",size:"sm",onClick:()=>E(s),children:e.jsx(Ve,{className:"w-4 h-4"})}),e.jsx(i,{variant:"ghost",size:"sm",onClick:()=>{u(s),M(!0)},children:e.jsx(Te,{className:"w-4 h-4 text-error"})})]})]}),e.jsxs("div",{className:"flex flex-wrap gap-2 mb-3",children:[e.jsxs(C,{children:[e.jsx($e,{className:"w-3 h-3 mr-1"}),Re[s.frequence]]}),s.destinataire&&e.jsxs(C,{children:[e.jsx(He,{className:"w-3 h-3 mr-1"}),s.destinataire]})]}),e.jsxs("div",{className:"mb-3 p-2 bg-primary-50 rounded-lg",children:[e.jsx("div",{className:"text-xs text-primary-500 mb-1",children:"Dernière version"}),a?e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx("span",{className:"text-sm font-medium",children:a.periode.mois?`${(J=F[a.periode.mois-1])==null?void 0:J.label} ${a.periode.annee}`:a.periode.annee}),e.jsx("span",{className:`text-xs px-2 py-0.5 rounded-full border ${Z[a.statut]}`,children:X[a.statut]})]}):e.jsx("span",{className:"text-sm text-primary-400",children:"Aucune version"})]}),e.jsxs("div",{className:"flex items-center justify-between text-sm",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(Be,{className:"w-4 h-4 text-primary-400"}),e.jsx("span",{className:"text-primary-600",children:"Prochaine:"})]}),o?e.jsxs("span",{className:x?"text-error font-medium":"text-primary-700",children:[W(o,"dd/MM/yyyy"),x&&e.jsx(G,{className:"w-4 h-4 inline ml-1 text-error"})]}):e.jsx("span",{className:"text-primary-400",children:"—"})]}),e.jsx(i,{variant:"secondary",size:"sm",className:"w-full mt-3",leftIcon:e.jsx(T,{className:"w-4 h-4"}),onClick:()=>be(s),children:"Nouvelle version"})]})};return e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-primary-900",children:"Reporting"}),e.jsx("p",{className:"text-primary-500 mt-1",children:S==null?void 0:S.nom})]}),e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx(f,{options:[{value:"all",label:"Tous les axes"},...R],value:p,onChange:s=>he(s.target.value),className:"w-48"}),e.jsx(f,{options:[{value:"all",label:"Toutes fréquences"},...z],value:I,onChange:s=>je(s.target.value),className:"w-44"}),e.jsx(i,{leftIcon:e.jsx(T,{className:"w-4 h-4"}),onClick:()=>E(),children:"Nouveau livrable"})]})]}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsx(j,{children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-primary-100 rounded-lg",children:e.jsx($,{className:"w-5 h-5 text-primary-600"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-primary-900",children:h.length}),e.jsx("div",{className:"text-sm text-primary-500",children:"Livrables"})]})]})})}),e.jsx(j,{children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-success/10 rounded-lg",children:e.jsx(_,{className:"w-5 h-5 text-success"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-success",children:fe.length}),e.jsx("div",{className:"text-sm text-primary-500",children:"À jour"})]})]})})}),e.jsx(j,{children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-error/10 rounded-lg",children:e.jsx(G,{className:"w-5 h-5 text-error"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-error",children:ge.length}),e.jsx("div",{className:"text-sm text-primary-500",children:"En retard"})]})]})})}),e.jsx(j,{children:e.jsx(v,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-info/10 rounded-lg",children:e.jsx(K,{className:"w-5 h-5 text-info"})}),e.jsxs("div",{children:[e.jsx("div",{className:"text-2xl font-bold text-info",children:h.reduce((s,a)=>s+a.historique.filter(o=>o.statut==="envoye").length,0)}),e.jsx("div",{className:"text-sm text-primary-500",children:"Envoyés"})]})]})})})]}),e.jsxs("div",{className:"space-y-4",children:[g.map(s=>{const a=ve[s.id]||[];if(p!=="all"&&p!==s.id||a.length===0&&p==="all")return null;const o=H.has(s.id);return e.jsxs(j,{children:[e.jsx(U,{className:"cursor-pointer hover:bg-primary-50 transition-colors",onClick:()=>Ne(s.id),children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[o?e.jsx(ke,{className:"w-5 h-5 text-primary-400"}):e.jsx(Ee,{className:"w-5 h-5 text-primary-400"}),e.jsx("div",{className:"w-4 h-4 rounded",style:{backgroundColor:s.couleur}}),e.jsx(Q,{children:s.nom})]}),e.jsxs(C,{children:[a.length," livrable(s)"]})]})}),o&&e.jsx(v,{children:a.length===0?e.jsx("div",{className:"text-center py-8 text-primary-500",children:"Aucun livrable pour cet axe"}):e.jsx("div",{className:"grid grid-cols-3 gap-4",children:a.map(x=>e.jsx(P,{livrable:x},x.id))})})]},s.id)}),O.length>0&&p==="all"&&e.jsxs(j,{children:[e.jsx(U,{children:e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsx(Q,{children:"Non classés"}),e.jsxs(C,{children:[O.length," livrable(s)"]})]})}),e.jsx(v,{children:e.jsx("div",{className:"grid grid-cols-3 gap-4",children:O.map(s=>e.jsx(P,{livrable:s},s.id))})})]}),h.length===0&&e.jsx(j,{children:e.jsxs(v,{className:"py-12 text-center",children:[e.jsx($,{className:"w-12 h-12 text-primary-300 mx-auto mb-4"}),e.jsx("p",{className:"text-primary-500",children:"Aucun livrable trouvé"}),e.jsx(i,{className:"mt-4",leftIcon:e.jsx(T,{className:"w-4 h-4"}),onClick:()=>E(),children:"Créer un livrable"})]})})]}),e.jsx(V,{isOpen:de,onClose:()=>{N(!1),L()},title:r?"Modifier le livrable":"Nouveau livrable",size:"lg",footer:e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"ghost",onClick:()=>N(!1),children:"Annuler"}),e.jsx(i,{onClick:Ce,children:r?"Enregistrer":"Créer"})]}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsx(w,{label:"Titre",value:t.titre,onChange:s=>m({...t,titre:s.target.value}),placeholder:"Ex: Rapport mensuel de fréquentation"}),e.jsx(Y,{label:"Description",rows:3,value:t.description,onChange:s=>m({...t,description:s.target.value}),placeholder:"Description du livrable..."}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(f,{label:"Axe stratégique",options:R,value:t.axeId,onChange:s=>m({...t,axeId:s.target.value})}),e.jsx(f,{label:"Fréquence",options:z,value:t.frequence,onChange:s=>m({...t,frequence:s.target.value})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(w,{label:"Destinataire",value:t.destinataire,onChange:s=>m({...t,destinataire:s.target.value}),placeholder:"Ex: Direction Générale"}),e.jsx(w,{label:"Modèle (optionnel)",value:t.modele,onChange:s=>m({...t,modele:s.target.value}),placeholder:"Lien vers le modèle"})]})]})}),e.jsx(V,{isOpen:me,onClose:()=>{b(!1),k()},title:`Nouvelle version - ${r==null?void 0:r.titre}`,size:"md",footer:e.jsxs(e.Fragment,{children:[e.jsx(i,{variant:"ghost",onClick:()=>b(!1),children:"Annuler"}),e.jsx(i,{onClick:we,children:"Créer la version"})]}),children:e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"grid grid-cols-2 gap-4",children:[e.jsx(w,{label:"Année",type:"number",value:l.periode.annee,onChange:s=>y({...l,periode:{...l.periode,annee:Number(s.target.value)}})}),e.jsx(f,{label:"Mois",options:F,value:String(l.periode.mois||1),onChange:s=>y({...l,periode:{...l.periode,mois:Number(s.target.value)}})})]}),e.jsx(Y,{label:"Commentaires (optionnel)",rows:3,value:l.commentaires,onChange:s=>y({...l,commentaires:s.target.value}),placeholder:"Notes sur cette version..."}),e.jsx("div",{className:"p-4 bg-primary-50 rounded-lg",children:e.jsxs("p",{className:"text-sm text-primary-600",children:[e.jsx("strong",{children:"Note:"})," Le fichier pourra être uploadé après la création de la version."]})})]})}),e.jsx(V,{isOpen:ue,onClose:()=>{D(!1),u(null)},title:`Historique - ${r==null?void 0:r.titre}`,size:"lg",footer:e.jsx(i,{variant:"ghost",onClick:()=>D(!1),children:"Fermer"}),children:r&&e.jsx("div",{className:"space-y-4",children:r.historique.length===0?e.jsx("div",{className:"text-center py-8 text-primary-500",children:"Aucune version disponible"}):e.jsx("div",{className:"space-y-3",children:r.historique.sort((s,a)=>new Date(a.dateCreation).getTime()-new Date(s.dateCreation).getTime()).map(s=>{var a;return e.jsxs("div",{className:"p-4 bg-primary-50 rounded-lg border border-primary-100",children:[e.jsxs("div",{className:"flex items-center justify-between mb-2",children:[e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx($,{className:"w-5 h-5 text-primary-400"}),e.jsxs("div",{children:[e.jsx("span",{className:"font-medium text-primary-900",children:s.periode.mois?`${(a=F[s.periode.mois-1])==null?void 0:a.label} ${s.periode.annee}`:s.periode.annee}),e.jsx("span",{className:"text-xs text-primary-500 ml-2",children:W(new Date(s.dateCreation),"dd/MM/yyyy HH:mm",{locale:ze})})]})]}),e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx("span",{className:`text-xs px-2 py-1 rounded-full border ${Z[s.statut]}`,children:X[s.statut]}),s.statut==="brouillon"&&e.jsx(i,{variant:"ghost",size:"sm",onClick:()=>B(r,s.id,"valide"),children:e.jsx(_,{className:"w-4 h-4 text-success"})}),s.statut==="valide"&&e.jsx(i,{variant:"ghost",size:"sm",onClick:()=>B(r,s.id,"envoye"),children:e.jsx(K,{className:"w-4 h-4 text-info"})})]})]}),s.commentaires&&e.jsx("p",{className:"text-sm text-primary-600 mt-2",children:s.commentaires})]},s.id)})})})}),e.jsx(Le,{isOpen:xe,onClose:()=>M(!1),onConfirm:Se,title:"Supprimer le livrable",message:`Êtes-vous sûr de vouloir supprimer "${r==null?void 0:r.titre}" et tout son historique ?`,confirmLabel:"Supprimer",variant:"danger"})]})}export{as as Reporting};
