import{j as e}from"./vendor-charts-cvMpHz0W.js";import{e as G,r as h}from"./vendor-react-BdB5Pz3t.js";import{a as K,u as Y,f as ee,B as N,C as u,g as p,h as R,i as $}from"./index-IaNwoOYO.js";import{B as E}from"./Badge-CM23X0aP.js";import{I as se}from"./Input-BZ7duGHL.js";import{M as te}from"./Modal-J_gxoCCM.js";import{d as D,p as d,z as ae,f as C,t as H}from"./vendor-utils-BBD155gO.js";import{Q as O,A as re,aX as S,h as P,a as ie,av as ne,b3 as _,a7 as le,ag as J,y as ce,f as oe,x as de}from"./vendor-icons-B6Rt7gcW.js";import{f as k}from"./fr-C0qvdQu_.js";import"./vendor-export-C98UG4Mq.js";function we(){const{centreId:b}=G(),w=K(s=>s.getCentre(b||"")),{addToast:I}=Y(),{projet:me,jalons:L,phasesHandover:B,reserves:xe,postesARecruter:T,vaguesRecrutement:q,prospects:he,loadProjet:M,updateJalon:V}=ee(),[Q,U]=h.useState(!0),[m,v]=h.useState(null),[W,j]=h.useState(!1),[A,y]=h.useState(0);h.useEffect(()=>{b&&M(b).finally(()=>U(!1))},[b,M]);const l=h.useMemo(()=>{const s=[],a=L||[],r=B||[],n=q||[],c=T||[];return a.filter(t=>t.categorie==="technique"||t.type==="handover").forEach(t=>{s.push({id:`jalon-${t.id}`,type:"chantier",categorie:"Jalon technique",titre:t.titre,dateBaseline:t.dateBaseline||t.dateCible,dateCible:t.dateCible,dateReelle:t.dateReelle,statut:t.statut,avancement:t.progression||0,impact:t.importance})}),r.forEach(t=>{s.push({id:`handover-${t.id}`,type:"chantier",categorie:"Handover",titre:t.nom,dateBaseline:t.dateDebut,dateCible:t.dateFin,statut:t.avancement===100?"termine":t.avancement>0?"en_cours":"a_venir",avancement:t.avancement||0,impact:"majeur"})}),a.filter(t=>["rh","commercial","marketing","operations"].includes(t.categorie||"")).forEach(t=>{s.push({id:`jalon-${t.id}`,type:"mobilisation",categorie:t.categorie==="rh"?"Recrutement":t.categorie==="commercial"?"Commercial":"Marketing",titre:t.titre,dateBaseline:t.dateBaseline,dateCible:t.dateCible,dateReelle:t.dateReelle,statut:t.statut,avancement:t.progression,dependances:t.dependances,impact:t.importance})}),n.forEach(t=>{const o=c.filter(f=>f.vagueId===t.id),z=o.filter(f=>f.statut==="integre").length;s.push({id:`recrutement-${t.id}`,type:"mobilisation",categorie:"Recrutement",titre:`Vague ${t.numero}: ${t.nom}`,dateBaseline:t.deadline,dateCible:t.deadline,statut:z===o.length?"termine":"en_cours",avancement:o.length>0?z/o.length*100:0,impact:t.priorite==="critique"?"critique":t.priorite==="haute"?"majeur":"normal",budget:o.reduce((f,Z)=>f+(Z.salaireMensuel||0),0)})}),s},[L,B,q,T]),g=h.useMemo(()=>{const s=l.filter(n=>n.type==="chantier");let a=0,r=null;return s.forEach(n=>{if(n.statut!=="termine"&&n.statut!=="atteint"){const c=D(new Date,d(n.dateCible));c>a&&(a=c,r=n)}}),{jours:Math.max(0,a),element:r}},[l]),x=h.useMemo(()=>{const s=[];return g.jours>0&&l.filter(r=>r.type==="mobilisation").forEach(r=>{const n=d(r.dateCible),c=new Date;ae(n,c)&&r.avancement<50&&D(n,c)<g.jours+30&&s.push({element:r,joursRetard:g.jours,cause:`Retard chantier de ${g.jours} jours`,elementsImpactes:[r],economiesPotentielles:r.budget?Math.round(r.budget*.5):void 0,recommandation:`Décaler de ${g.jours} jours pour aligner avec le chantier`})}),s},[l,g]),i=h.useMemo(()=>{const s=l.filter(t=>t.type==="chantier"),a=l.filter(t=>t.type==="mobilisation"),r=s.length>0?s.reduce((t,o)=>t+o.avancement,0)/s.length:0,n=a.length>0?a.reduce((t,o)=>t+o.avancement,0)/a.length:0,c=n-r;return{avancementChantier:Math.round(r),avancementMobilisation:Math.round(n),ecart:Math.round(c),retardChantier:g.jours,elementsEnAvance:a.filter(t=>t.avancement>r+10).length,economiesPotentielles:x.reduce((t,o)=>t+(o.economiesPotentielles||0),0)}},[l,g,x]),X=async(s,a)=>{try{for(const r of s.elementsImpactes)if(r.id.startsWith("jalon-")){const n=r.id.replace("jalon-",""),c=C(H(d(r.dateCible),a),"yyyy-MM-dd");await V(n,{dateCible:c})}I({type:"success",title:"Dates ajustées",message:`${s.elementsImpactes.length} élément(s) décalé(s) de ${a} jours`}),j(!1),v(null)}catch(r){I({type:"error",title:"Erreur",message:String(r)})}},F=({element:s})=>{const a=s.statut==="en_retard"||s.statut!=="termine"&&s.statut!=="atteint"&&D(new Date,d(s.dateCible))>0,r=s.statut==="termine"||s.statut==="atteint";return e.jsxs("div",{className:`p-3 rounded-lg border ${r?"bg-success/5 border-success/20":a?"bg-error/5 border-error/20":"bg-white border-primary-200"}`,children:[e.jsxs("div",{className:"flex items-start justify-between",children:[e.jsxs("div",{className:"flex-1 min-w-0",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(E,{className:`text-xs ${s.categorie==="Recrutement"?"bg-purple-100 text-purple-700":s.categorie==="Commercial"?"bg-blue-100 text-blue-700":s.categorie==="Marketing"?"bg-pink-100 text-pink-700":"bg-orange-100 text-orange-700"}`,children:s.categorie}),s.impact==="critique"&&e.jsx(de,{className:"w-4 h-4 text-error"})]}),e.jsx("p",{className:"font-medium text-primary-900 mt-1 truncate",children:s.titre}),e.jsxs("p",{className:"text-xs text-primary-500 mt-0.5",children:["Cible: ",C(d(s.dateCible),"dd MMM yyyy",{locale:k})]})]}),e.jsx("div",{className:"text-right",children:e.jsxs("div",{className:`text-lg font-bold ${r?"text-success":a?"text-error":"text-primary-900"}`,children:[s.avancement,"%"]})})]}),e.jsx("div",{className:"mt-2 h-1.5 bg-primary-100 rounded-full overflow-hidden",children:e.jsx("div",{className:`h-full rounded-full transition-all ${r?"bg-success":a?"bg-error":"bg-accent"}`,style:{width:`${s.avancement}%`}})})]})};return Q?e.jsx("div",{className:"flex items-center justify-center h-64",children:e.jsx(O,{className:"w-8 h-8 text-primary-300 animate-spin"})}):e.jsxs("div",{className:"space-y-6",children:[e.jsxs("div",{className:"flex items-center justify-between",children:[e.jsxs("div",{children:[e.jsx("h1",{className:"text-2xl font-bold text-primary-900",children:"Synchronisation Chantier / Mobilisation"}),e.jsxs("p",{className:"text-primary-500 mt-1",children:[w==null?void 0:w.nom," - Alignez les plannings pour optimiser les ressources"]})]}),e.jsx(N,{leftIcon:e.jsx(O,{className:"w-4 h-4"}),onClick:()=>M(b||""),children:"Actualiser"})]}),i.retardChantier>0&&e.jsx(u,{className:"border-warning bg-warning/5",children:e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-start gap-4",children:[e.jsx("div",{className:"p-3 bg-warning/10 rounded-lg",children:e.jsx(re,{className:"w-6 h-6 text-warning"})}),e.jsxs("div",{className:"flex-1",children:[e.jsxs("h3",{className:"font-bold text-primary-900",children:["Retard chantier détecté : ",i.retardChantier," jours"]}),e.jsxs("p",{className:"text-primary-600 mt-1",children:[x.length," action(s) de mobilisation pourraient être décalées pour économiser des ressources.",i.economiesPotentielles>0&&e.jsxs("span",{className:"font-medium text-success ml-1",children:["Économies potentielles : ",i.economiesPotentielles.toLocaleString()," FCFA/mois"]})]})]}),e.jsx(N,{variant:"outline",onClick:()=>{x.length>0&&(v(x[0]),y(i.retardChantier),j(!0))},children:"Voir les recommandations"})]})})}),e.jsxs("div",{className:"grid grid-cols-4 gap-4",children:[e.jsx(u,{children:e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-orange-100 rounded-lg",children:e.jsx(S,{className:"w-5 h-5 text-orange-600"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold text-primary-900",children:[i.avancementChantier,"%"]}),e.jsx("div",{className:"text-sm text-primary-500",children:"Avancement chantier"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:"p-2 bg-purple-100 rounded-lg",children:e.jsx(P,{className:"w-5 h-5 text-purple-600"})}),e.jsxs("div",{children:[e.jsxs("div",{className:"text-2xl font-bold text-primary-900",children:[i.avancementMobilisation,"%"]}),e.jsx("div",{className:"text-sm text-primary-500",children:"Avancement mobilisation"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${i.ecart>10?"bg-warning/10":i.ecart<-10?"bg-error/10":"bg-success/10"}`,children:e.jsx(ie,{className:`w-5 h-5 ${i.ecart>10?"text-warning":i.ecart<-10?"text-error":"text-success"}`})}),e.jsxs("div",{children:[e.jsxs("div",{className:`text-2xl font-bold ${i.ecart>10?"text-warning":i.ecart<-10?"text-error":"text-success"}`,children:[i.ecart>0?"+":"",i.ecart,"%"]}),e.jsx("div",{className:"text-sm text-primary-500",children:"Écart mob./chantier"})]})]})})}),e.jsx(u,{children:e.jsx(p,{className:"p-4",children:e.jsxs("div",{className:"flex items-center gap-3",children:[e.jsx("div",{className:`p-2 rounded-lg ${i.elementsEnAvance>0?"bg-warning/10":"bg-success/10"}`,children:e.jsx(ne,{className:`w-5 h-5 ${i.elementsEnAvance>0?"text-warning":"text-success"}`})}),e.jsxs("div",{children:[e.jsx("div",{className:`text-2xl font-bold ${i.elementsEnAvance>0?"text-warning":"text-success"}`,children:i.elementsEnAvance}),e.jsx("div",{className:"text-sm text-primary-500",children:"Mobilisations en avance"})]})]})})})]}),e.jsxs("div",{className:"grid grid-cols-2 gap-6",children:[e.jsxs(u,{children:[e.jsx(R,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(S,{className:"w-5 h-5 text-orange-600"}),"Chantier / Travaux",i.retardChantier>0&&e.jsxs(E,{className:"bg-error/10 text-error ml-2",children:["-",i.retardChantier,"j"]})]})}),e.jsxs(p,{className:"space-y-3",children:[l.filter(s=>s.type==="chantier").sort((s,a)=>d(s.dateCible).getTime()-d(a.dateCible).getTime()).map(s=>e.jsx(F,{element:s},s.id)),l.filter(s=>s.type==="chantier").length===0&&e.jsxs("div",{className:"text-center py-8 text-primary-400",children:[e.jsx(S,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Aucun jalon chantier défini"})]})]})]}),e.jsxs(u,{children:[e.jsx(R,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(P,{className:"w-5 h-5 text-purple-600"}),"Mobilisation",i.ecart>10&&e.jsx(E,{className:"bg-warning/10 text-warning ml-2",children:"En avance"})]})}),e.jsxs(p,{className:"space-y-3",children:[l.filter(s=>s.type==="mobilisation").sort((s,a)=>d(s.dateCible).getTime()-d(a.dateCible).getTime()).map(s=>{const a=x.find(r=>r.element.id===s.id);return e.jsxs("div",{className:"relative",children:[a&&e.jsx("button",{onClick:()=>{v(a),y(a.joursRetard),j(!0)},className:"absolute -right-2 -top-2 p-1 bg-warning rounded-full text-white shadow-lg hover:bg-warning/80 transition-colors z-10",children:e.jsx(_,{className:"w-4 h-4"})}),e.jsx(F,{element:s})]},s.id)}),l.filter(s=>s.type==="mobilisation").length===0&&e.jsxs("div",{className:"text-center py-8 text-primary-400",children:[e.jsx(P,{className:"w-12 h-12 mx-auto mb-2 opacity-50"}),e.jsx("p",{children:"Aucune action de mobilisation définie"})]})]})]})]}),x.length>0&&e.jsxs(u,{children:[e.jsx(R,{children:e.jsxs($,{className:"flex items-center gap-2",children:[e.jsx(_,{className:"w-5 h-5 text-warning"}),"Recommandations de synchronisation"]})}),e.jsx(p,{children:e.jsx("div",{className:"space-y-3",children:x.map((s,a)=>e.jsxs("div",{className:"p-4 bg-warning/5 border border-warning/20 rounded-lg flex items-center justify-between",children:[e.jsxs("div",{className:"flex items-center gap-4",children:[e.jsx("div",{className:"p-2 bg-warning/10 rounded-lg",children:e.jsx(le,{className:"w-5 h-5 text-warning"})}),e.jsxs("div",{children:[e.jsx("p",{className:"font-medium text-primary-900",children:s.element.titre}),e.jsx("p",{className:"text-sm text-primary-500",children:s.recommandation}),s.economiesPotentielles&&e.jsxs("p",{className:"text-sm text-success font-medium mt-1",children:[e.jsx(J,{className:"w-3 h-3 inline"}),"Économie potentielle: ",s.economiesPotentielles.toLocaleString()," FCFA/mois"]})]})]}),e.jsx(N,{size:"sm",onClick:()=>{v(s),y(s.joursRetard),j(!0)},children:"Ajuster"})]},a))})})]}),x.length===0&&i.retardChantier===0&&e.jsx(u,{className:"border-success bg-success/5",children:e.jsxs(p,{className:"p-6 text-center",children:[e.jsx(ce,{className:"w-12 h-12 text-success mx-auto mb-3"}),e.jsx("h3",{className:"text-lg font-bold text-primary-900",children:"Plannings synchronisés"}),e.jsx("p",{className:"text-primary-600 mt-1",children:"Le chantier et la mobilisation sont bien alignés. Aucun ajustement nécessaire."})]})}),e.jsx(te,{isOpen:W,onClose:()=>j(!1),title:"Ajuster le planning",size:"md",footer:e.jsxs("div",{className:"flex gap-2",children:[e.jsx(N,{variant:"ghost",onClick:()=>j(!1),children:"Annuler"}),e.jsx(N,{onClick:()=>m&&X(m,A),children:"Appliquer le décalage"})]}),children:m&&e.jsxs("div",{className:"space-y-4",children:[e.jsxs("div",{className:"p-4 bg-primary-50 rounded-lg",children:[e.jsx("h4",{className:"font-medium text-primary-900",children:m.element.titre}),e.jsx("p",{className:"text-sm text-primary-500 mt-1",children:m.cause})]}),e.jsxs("div",{children:[e.jsx("label",{className:"block text-sm font-medium text-primary-700 mb-2",children:"Décalage en jours"}),e.jsx(se,{type:"number",value:A,onChange:s=>y(Number(s.target.value)),min:0,max:365})]}),e.jsx("div",{className:"p-4 bg-warning/10 rounded-lg",children:e.jsxs("div",{className:"flex items-start gap-3",children:[e.jsx(oe,{className:"w-5 h-5 text-warning mt-0.5"}),e.jsxs("div",{children:[e.jsxs("p",{className:"text-sm text-primary-700",children:[e.jsx("strong",{children:"Date actuelle:"})," ",C(d(m.element.dateCible),"dd MMMM yyyy",{locale:k})]}),e.jsxs("p",{className:"text-sm text-primary-700 mt-1",children:[e.jsx("strong",{children:"Nouvelle date:"})," ",C(H(d(m.element.dateCible),A),"dd MMMM yyyy",{locale:k})]})]})]})}),m.economiesPotentielles&&e.jsxs("div",{className:"p-4 bg-success/10 rounded-lg",children:[e.jsxs("div",{className:"flex items-center gap-2",children:[e.jsx(J,{className:"w-5 h-5 text-success"}),e.jsxs("p",{className:"text-sm text-success font-medium",children:["Économie potentielle: ",m.economiesPotentielles.toLocaleString()," FCFA/mois"]})]}),e.jsx("p",{className:"text-xs text-primary-500 mt-1",children:"En décalant cette action, vous évitez d'engager des dépenses prématurément."})]})]})})]})}export{we as ProjetSynchronisation};
